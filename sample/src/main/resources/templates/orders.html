<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Orders - Medicine Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-pills me-2"></i>
                Medicine Inventory
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/medicines">Medicines</a>
                <a class="nav-link" href="/users">Users</a>
                <a class="nav-link active" href="/orders">Orders</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Order Management</h2>
        
        <!-- Create Order Form -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Create New Order</h5>
            </div>
            <div class="card-body">
                <form id="orderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">User ID</label>
                            <input type="number" class="form-control" id="userId" placeholder="Enter User ID" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total Amount (₹)</label>
                            <input type="number" class="form-control" id="totalAmount" placeholder="Enter total amount" step="0.01" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Delivery Address</label>
                            <textarea class="form-control" id="deliveryAddress" placeholder="Enter delivery address" rows="3" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Delivery Phone</label>
                            <input type="text" class="form-control" id="deliveryPhone" placeholder="Enter phone number" required>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" onclick="createOrder()">
                            <i class="fas fa-plus me-1"></i>Create Order
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Orders List -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">All Orders</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchUserId" placeholder="Search by User ID">
                </div>
                <div id="ordersList">
                    <p class="text-muted">No orders to display. Use the search above or create a new order.</p>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/app.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function createOrder() {
            const userId = document.getElementById('userId').value;
            const totalAmount = document.getElementById('totalAmount').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const deliveryPhone = document.getElementById('deliveryPhone').value;

            if (!userId || !totalAmount || !deliveryAddress || !deliveryPhone) {
                alert('Please fill all fields');
                return;
            }

            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: parseInt(userId),
                    totalAmount: parseFloat(totalAmount),
                    deliveryAddress: deliveryAddress,
                    deliveryPhone: deliveryPhone
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('Order created successfully! Order Number: ' + data.orderNumber);
                document.getElementById('orderForm').reset();
                loadUserOrders(userId);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating order: ' + error.message);
            });
        }

        function loadUserOrders(userId) {
            if (!userId) return;
            
            fetch('/api/orders/user/' + userId)
                .then(response => response.json())
                .then(orders => {
                    const ordersList = document.getElementById('ordersList');
                    
                    if (orders.length === 0) {
                        ordersList.innerHTML = '<p class="text-muted">No orders found for this user.</p>';
                        return;
                    }

                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Order Number</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Order Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    orders.forEach(order => {
                        html += `
                            <tr>
                                <td>${order.orderNumber}</td>
                                <td>₹${order.totalAmount}</td>
                                <td>
                                    <span class="badge ${getStatusBadgeClass(order.status)}">${order.status}</span>
                                </td>
                                <td>${new Date(order.orderDate).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="updateOrderStatus(${order.orderId}, 'CONFIRMED')">
                                        Confirm
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="updateOrderStatus(${order.orderId}, 'DELIVERED')">
                                        Deliver
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;

                    ordersList.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('ordersList').innerHTML = '<p class="text-danger">Error loading orders</p>';
                });
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'PENDING': return 'bg-warning';
                case 'CONFIRMED': return 'bg-info';
                case 'PROCESSING': return 'bg-primary';
                case 'DELIVERED': return 'bg-success';
                case 'CANCELLED': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function updateOrderStatus(orderId, status) {
            fetch(`/api/orders/${orderId}/status?status=${status}`, {
                method: 'PUT'
            })
            .then(response => response.json())
            .then(data => {
                alert('Order status updated to: ' + status);
                const searchUserId = document.getElementById('searchUserId').value;
                if (searchUserId) {
                    loadUserOrders(searchUserId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating order status');
            });
        }

        // Add event listener for search
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchUserId').addEventListener('input', function() {
                const userId = this.value;
                if (userId) {
                    loadUserOrders(userId);
                } else {
                    document.getElementById('ordersList').innerHTML = '<p class="text-muted">No orders to display. Use the search above or create a new order.</p>';
                }
            });
        });
        <div class="navbar-nav">
    <a class="nav-link" href="/">Home</a>
    <a class="nav-link" href="/medicines">Medicines</a>
    <a class="nav-link" href="/users">Users</a>
    <a class="nav-link" href="/orders">Orders</a>
</div>
    </script>
</body>
</html>